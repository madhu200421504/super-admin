<!-- Main Dashboard Content -->
<ng-container *ngIf="!selectedDealer && !selectedSM">
  <div class="dashboard-container">

    <!-- Filter Pills -->
    <div style="
        background-color: white;
        display: inline-flex;
        gap: 6px;
        color:#000;
        padding: 4px;
        border-radius: 999px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-family: 'Poppins', sans-serif;
    ">
      <button *ngFor="let option of ['MTD', 'QTD', 'YTD']" (click)="onFilterChange(option)"
        [ngClass]="{ 'pill-active': selectedFilter === option }" class="pill-button">
        {{ option }}
      </button>
    </div>

    <!-- Metrics Section -->
    <div class="dashboard-container" style="margin-top:60px;">
      <div class="metrics-row" style="display: flex; gap: 15px; margin-top: -45px;font-family: 'Poppins', sans-serif;">

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.totalLeads }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Enquiries</div>
        </div>

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.totalTestDrives }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Test Drives</div>
        </div>

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.totalOrders }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">New Orders</div>
        </div>

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.lostLeads }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">New Lost leads</div>
        </div>

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.cancellations }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Cancellation</div>
        </div>

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{
            dashboardMetrics.netOrders }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif;">Net Order</div>
        </div>

        <div class="metric-box" style="border: 1px solid #E4E4E7; border-radius: 10px; overflow: hidden;">
          <div class="metric-value" style="color:black;font-size:1.125rem;font-weight:500;">{{ dashboardMetrics.retail
            }}</div>
          <div class="metric-label"
            style="color:#000;font-size:18px;font-weight:400;font-family: 'Poppins', sans-serif">Retail</div>
        </div>
      </div>
    </div>

    <!-- Dealers List -->
    <div class="main-content" style="margin-top:20px;">
      <ng-container *ngIf="dealers && dealers.length">
        <div *ngFor="let dealer of paginatedDealers" class="team-wrapper" style="margin-bottom: 20px;">

          <div class="team-container" (click)="onDealerClick(dealer.dealer_id)">
            <!-- Dealer Name -->
            <div class="team-name">
              {{ dealer.dealer_name }}
              <i class="fas" style="margin-left: 10px;"></i>
            </div>

            <!-- Dealer KPIs -->
            <div class="metrics-wrapper" style="font-family: 'Poppins', sans-serif;">
              <div class="metric-card" style="background-color:#6FCBF9;color:#FFFFFF;">
                <i class="fas fa-car"></i>
                <span>Enquiries</span>
                <span class="metric-value">{{ dealer.enquiries || 0 }}</span>
              </div>

              <div class="metric-card" style="background-color:#FF9CDE;color:#FFFFFF;">
                <i class="fas fa-file-alt"></i>
                <span>Test Drives</span>
                <span class="metric-value">{{ dealer.testDrives || 0 }}</span>
              </div>

              <div class="metric-card" style="background-color:#BFDCFC;color:#FFFFFF;">
                <i class="fas fa-file-signature"></i>
                <span>Orders</span>
                <span class="metric-value">{{ dealer.orders || 0 }}</span>
              </div>

              <div class="metric-card" style="background-color:#FFB6B6;color:#FFFFFF;">
                <i class="fas fa-user-slash"></i>
                <span>Lost Leads</span>
                <span class="metric-value">{{ dealer.lostLeads || 0 }}</span>
              </div>

              <div class="metric-card" style="background-color:#9CED97;color:#FFFFFF;">
                <i class="fas fa-times-circle"></i>
                <span>Cancellations</span>
                <span class="metric-value">{{ dealer.cancellations || 0 }}</span>
              </div>

              <div class="metric-card" style="background-color:#C59CFF;color:#FFFFFF;">
                <i class="fas fa-store"></i>
                <span>Net Orders</span>
                <span class="metric-value">{{ dealer.netOrders || 0 }}</span>
              </div>

              <div class="metric-card" style="background-color:#DCF471;color:#FFFFFF;">
                <i class="fas fa-shopping-cart"></i>
                <span>Retail</span>
                <span class="metric-value">{{ dealer.retail || 0 }}</span>
              </div>
            </div>
          </div>

          <!-- SM Cards (shown when dealer is expanded) -->
          <div *ngIf="selectedDealerId === dealer.dealer_id" class="sm-card-wrapper"
            style="margin-top: 12px; padding-left: 10px;">
            <div *ngIf="dealerSMS[dealer.dealer_id]?.length; else noSm" class="sm-card-container"
              style="display: flex; flex-wrap: wrap; gap: 16px;">

              <div *ngFor="let sm of dealerSMS[dealer.dealer_id]; let i = index" class="sm-card" (click)="onSMClick(sm)"
                (mouseenter)="hoveredSM = sm.sm_id" (mouseleave)="hoveredSM = null"
                style="position: relative; width: 100px; text-align: center; cursor: pointer;">

                <!-- Avatar -->
                <div class="sm-avatar" [ngStyle]="{
                      'width.px': 60,
                      'height.px': 60,
                      'margin': '0 auto 12px auto',
                      'border-radius': '50%',
                      'display': 'flex',
                      'align-items': 'center',
                      'justify-content': 'center',
                      'font-weight': 600,
                      'font-size.px': 24,
                      'background': getAvatarColor(i).background,
                      'color': getAvatarColor(i).text
                    }">
                  {{ sm.sm_name.charAt(0).toUpperCase() }}
                </div>

                <!-- SM Name -->
                <div class="sm-name" style="font-size: 12px; font-weight: 500; color: #2c2c2c; line-height: 1.4;">
                  {{ sm.sm_name }}
                </div>

                <!-- Hover Box for Enquiries -->
                <div *ngIf="hoveredSM === sm.sm_id" style="position: absolute; top: 90px; left: 50%; transform: translateX(-50%);
                          background: #f0f0ff; border: 1px solid #ccc; padding: 8px 12px;
                          border-radius: 8px; font-size: 12px; color: #333;
                          white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                          z-index: 10; text-align: left; line-height: 1.6;">
                  <div><strong>Enquiries:</strong> {{ sm.enquiries }}</div>
                  <div><strong>Test Drives:</strong> {{ sm.testDrives }}</div>
                  <div><strong>Orders:</strong> {{ sm.orders }}</div>
                  <div><strong>Cancellations:</strong> {{ sm.cancellations }}</div>
                  <div><strong>Net Orders:</strong> {{ sm.netOrders }}</div>
                  <div><strong>Retail:</strong> {{ sm.retail }}</div>
                </div>
              </div>
            </div>

            <ng-template #noSm>
              <div *ngIf="dealerSMS[dealer.dealer_id]?.length === 0">
                <ng-container *ngTemplateOutlet="noSm"></ng-container>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
          <button (click)="goToPage(currentdealerPage - 1)" [disabled]="currentdealerPage === 1">Prev</button>

          <span *ngFor="let page of [].constructor(totalDealerPages); let i = index">
            <button (click)="goToPage(i + 1)" [class.active]="currentdealerPage === i + 1" style="margin: 0 4px;">
              {{ i + 1 }}
            </button>
          </span>

          <button (click)="goToPage(currentdealerPage + 1)"
            [disabled]="currentdealerPage === totalDealerPages">Next</button>
        </div>
      </ng-container>
    </div>

    <div class="pagination-info"
      style="text-align: center; font-size: 14px; margin-top: 10px; font-family: 'Poppins', sans-serif;">
      {{ getShowingRange() }}
    </div>
  </div>
</ng-container>

<!-- PS1 & PS2 Cards Section (only shown when SM is selected) -->
<div class="ps-cards-page" *ngIf="selectedSM" style="margin-top: 40px;">
  <button class="back-arrow" (click)="goBack()" title="Go Back">
    ←
  </button>
  <h2 style="margin: 16px 0;">{{ selectedSM.sm_name }}</h2>

  <div class="ps-section" style="display: flex; gap: 40px; flex-wrap: wrap;">

    <!-- PS1 Cards -->
    <!-- PS1 Cards -->
<div class="ps-cards" style="padding-bottom: 120px;">
      <h3 style="font-weight: 600; margin-bottom: 16px;"></h3>
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div *ngFor="let item of paginatedPs1Data let i = index" (mouseenter)="hoveredPS = item.ps_id"
          (mouseleave)="hoveredPS = null" (click)="onPSCardClick(item.ps_id)"
          style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06); padding: 16px; width: 120px; text-align: center; cursor: pointer; position: relative;">

          <!-- Avatar with dynamic color -->
          <div [ngStyle]="getAvatarStyle(i)">
            {{ item.ps_name.charAt(0).toUpperCase() }}
          </div>

          <!-- Name -->
        <div style="
            font-size: 12px;
            font-weight: 600;
            color: #2c2c2c;
            margin-top: 8px;
            font-family: 'Poppins', sans-serif;
          ">
          {{ item.ps_name }}
        </div>

          <!-- Tooltip -->
          <div *ngIf="hoveredPS === item.ps_id" style="
              position: absolute;
              top: 90%;
              left: 50%;
              transform: translateX(-50%);
              background: #f0f0ff;
              border: 1px solid #ccc;
              padding: 8px 12px;
              border-radius: 8px;
              font-size: 12px;
              color: #333;
              white-space: nowrap;
              box-shadow: 0 2px 6px rgba(0,0,0,0.1);
              z-index: 10;
              text-align: left;
              line-height: 1.6;
            ">
            <div><strong>Enquiries:</strong> {{ item.enquiries }}</div>
            <div><strong>Test Drives:</strong> {{ item.testDrives }}</div>
            <div><strong>Orders:</strong> {{ item.orders }}</div>
            <div><strong>Cancellations:</strong> {{ item.cancellations }}</div>
            <div><strong>Net Orders:</strong> {{ item.netOrders }}</div>
            <div><strong>Retail:</strong> {{ item.retail }}</div>
          </div>
        </div>
      </div>
    </div>
<div style="width: 100%; margin-top: 24px;">
  <div style="display: flex; justify-content: flex-end; align-items: center; padding-right: 50px;margin-top:-50px;">
    <button (click)="currentPage = currentPage - 1" [disabled]="currentPage === 1"
      style="padding: 6px 12px; margin-right: 8px; border: 1px solid #ccc; background: #f5f5f5; color: #666; cursor: pointer;">
      Prev
    </button>

    <span style="margin: 0 8px; color: #555;">
      Page {{ currentPage }} of {{ totalPs1Pages }}
    </span>

    <button (click)="currentPage = currentPage + 1" [disabled]="currentPage === totalPs1Pages"
      style="padding: 6px 12px; margin-left: 8px; border: 1px solid #222fb9; background: white; color: #222fb9; cursor: pointer;">
      Next
    </button>
  </div>
</div>



  </div>
</div>

<!-- Pagination aligned to right -->

<!-- </div> -->

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('doughnutChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Red', 'Blue', 'Yellow'],
      datasets: [{
        data: [300, 50, 100],
        backgroundColor: ['#ff0000', '#0000ff', '#ffff00'],
        hoverOffset: 4
      }]
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    fetch('https://uat.smartassistapp.in/api/superAdmin/superAdmin-dashboardd') // Replace with your actual API endpoint
      .then(response => response.json())
      .then(data => {
        populateTable(data.data.rankings.leads); // Assuming the structure is data.data.rankings.leads
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        // Optionally display an error message in the table
      });

    function populateTable(leadsData) {
      const tableBody = document.querySelector('#dataTable tbody');
      tableBody.innerHTML = ''; // Clear any existing rows

      leadsData.forEach(dealer => {
        const row = tableBody.insertRow();
        const nameCell = row.insertCell();
        const codeCell = row.insertCell();
        const locationCell = row.insertCell();
        const phoneCell = row.insertCell();
        const countCell = row.insertCell();
        const rankCell = row.insertCell();

        nameCell.textContent = dealer.dealer_name;
        codeCell.textContent = dealer.dealer_code;
        locationCell.textContent = dealer.location;
        phoneCell.textContent = dealer.phone || dealer.mobile || ''; // Use phone if available, otherwise mobile
        countCell.textContent = dealer.value;
        rankCell.textContent = dealer.rank;
      });
    }
  });
</script>